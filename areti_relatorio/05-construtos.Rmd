

# Construtos

```{r sesdasdasdaaaatup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  error = FALSE,
  warning = FALSE,
  fig.width = 12
)
library(knitr)
library(JLutils)
library(kableExtra)
library(ggplot2)
library(ggrepel)
library(polycor)  
library(psych)
library(FactoMineR)
library(pheatmap)
library(tidyverse)

wrap_palavra_grande2 <- function(a) {
  a %>% stringr::str_replace_all("_", " ") %>% stringr::str_wrap(20) %>% stringr::str_replace_all(" ", "_")
}

#
wrap_palavra_grande <- function(palavras, n = 50) {
  linha1 <- palavras %>% str_sub(1, -n)
  linha2 <- palavras %>% str_sub(-n+1)
  map2_chr(linha1, linha2, paste, sep = "\n")
}

#
categs_likert_ordenados <- c(
  "Discordo totalmente"
  ,"Discordo parcialmente"
  ,"Não concordo nem discordo"
  ,"Concordo parcialmente"
  ,"Concordo totalmente"
)

#
eh_likert <- function(x) {
  any(x %in% categs_likert_ordenados)
}

#
sumariza_likert <- function(data, variaveis_selecionadas, cortes) {
  categs_likert_ordenados <- c(
    "Discordo totalmente"
    ,"Discordo parcialmente"
    ,"Não concordo nem discordo"
    ,"Concordo parcialmente"
    ,"Concordo totalmente"
  )
  
  data <- data %>%
    tidyr::gather("question", "response", !!variaveis_selecionadas) %>%  
    dplyr::filter(response %in% categs_likert_ordenados) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(
      group = do.call(partial(paste, sep = "|"), syms(cortes))
    ) %>%
    dplyr::group_by(group) %>%
    dplyr::mutate(
      count_group = length(group)
    ) %>%
    dplyr::group_by(question, group, response) %>%
    dplyr::summarise(
      count_group = first(count_group),
      count = length(group)
    ) %>%
    dplyr::group_by(question, group) %>%
    dplyr::mutate(
      group_n = glue::glue("{group} ({sum(count)})"),
      p = count/sum(count),
      p_lbl = scales::percent(p, 0.1, decimal.mark = ","),
      p_lbl = if_else(p < 0.011, "", p_lbl)
    ) %>%
    dplyr::select(-count_group) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(
      count_concordo_totalmente = dplyr::if_else(response %in% "Concordo totalmente", .$p, 0.0),
      response = fct_relevel(response, !!rev(categs_likert_ordenados))
    ) %>%
    dplyr::left_join(papel_das_variaveis %>% dplyr::select(question = variavel_nome, variavel_texto, ordem_das_variaveis) %>% dplyr::distinct()) %>%
    dplyr::mutate(
      variavel_texto = str_wrap(variavel_texto, width = 40)
    )
  
  
  data
}

#
grafico_likert <- function(colaboradores_sumario, titulo = "", ordena_por_concordo = TRUE) {
  
  if(ordena_por_concordo) {
    colaboradores_sumario  <- colaboradores_sumario %>%
      dplyr::mutate(
        variavel_texto = fct_reorder(
          factor(variavel_texto), 
          -count_concordo_totalmente, 
          .fun = "mean"
        )
      )
  } else {
    colaboradores_sumario  <- colaboradores_sumario %>%
      dplyr::mutate(
        variavel_texto = fct_reorder(
          factor(variavel_texto), 
          ordem_das_variaveis, 
          .fun = "mean"
        )
      )
  }
  
  colaboradores_sumario %>%
    dplyr::filter(!is.na(response)) %>%
    ggplot(aes(x = group_n, y = p, fill = response)) +
    geom_col(position = "stack") +
    geom_label(
      aes(label = p_lbl), 
      position = position_stack(vjust = .5), 
      colour = "white", 
      fontface = "bold", 
      label.size = 0
    ) +
    coord_flip() +
    scale_fill_manual(values = rev(c("#CA0020", "#F4A582", "#979797", "#92C5DE", "#0571B0"))) + 
    theme_minimal(14, base_family = "serif") +
    theme(legend.position="top",
          axis.text.y = element_text(hjust = 0),
          strip.text.y = element_text(angle = 180, hjust = 0),
          strip.placement = "outside"
    ) +
    guides(fill = guide_legend(nrow = 2, byrow = FALSE)) +
    labs(fill = "Resposta:", x = "", y = "") +
    scale_y_continuous(labels = scales::percent_format(decimal.mark = ","))+
    scale_x_discrete(labels = partial(str_wrap, width = 40)) +
    facet_grid(variavel_texto~., switch = "y", scales = "free_y") +
    ggtitle(titulo)
}

```



```{r a}
#BDs
colaboradores <- readRDS("D:/OneDrive/Documents/areti/data/colaboradores.rds") 
construtos <- readxl::read_xlsx("D:/OneDrive/Documents/areti/data/Questoes_e_Construtos v3.xlsx", sheet = "construtos Moema Dani")
variaveis <- readxl::read_xlsx("D:/OneDrive/Documents/areti/data/Questoes_e_Construtos v3.xlsx", sheet = "variaveis")
depara_construtos <- readxl::read_xlsx("D:/OneDrive/Documents/areti/data/Questoes_e_Construtos v3.xlsx", sheet = "depara_construtos")

papel_das_variaveis <- construtos %>% 
  left_join(variaveis) %>%
  dplyr::mutate(
    variavel_nome = variavel_nome %>% stringr::str_replace_all('\"', ''),
    variavel_nome = nome %>% stringr::str_replace_all('\"', ''),
    ordem_das_variaveis = as.numeric(fct_inorder(variavel_nome))
  ) %>%
  dplyr::group_by(variavel_nome) %>%
  mutate(
    variavel_texto = first(variavel_texto[!is.na(variavel_texto)])
  )
```





## Descredibilidade e Injustiça


```{r descredibilidade_e_injustica_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Descredibilidade e Injustiça")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r descredibilidade_e_injustica_b, fig.height=9}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Descredibilidade e Injustiça"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r descredibilidade_e_injustica_c}
## polychoric             
# descredibilidade_e_injustica_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(descredibilidade_e_injustica_pc, file = "../data/descredibilidade_e_injustica_pc.rds")
```

```{r descredibilidade_e_injustica_g, fig.width=12, fig.height=8}
descredibilidade_e_injustica_pc <- readRDS(file = "../data/descredibilidade_e_injustica_pc.rds")

library("pheatmap")
pheatmap(
  (descredibilidade_e_injustica_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 2, 
  cutree_cols = 2, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r descredibilidade_e_injustica_ee, include=FALSE}
## factor analysis
descredibilidade_e_injustica_fa_par = fa.parallel(descredibilidade_e_injustica_pc$correlations, n.obs = nrow(colaboradores))
```

```{r descredibilidade_e_injustica_eeee}
plot(descredibilidade_e_injustica_fa_par)
```


```{r descredibilidade_e_injustica_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in% c("Descredibilidade e Injustiça")
  ) %>%
  pluck("conclusao") %>%
  cat
```


```{r descredibilidade_e_injustica_e, fig.width=8}
descredibilidade_e_injustica_fa <- fa(
  descredibilidade_e_injustica_pc$correlations, 
  nfactors = 2, # descredibilidade_e_injustica_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(descredibilidade_e_injustica_fa, file = "../data/descredibilidade_e_injustica_fa.rds")
```

```{r descredibilidade_e_injustica_f}
descredibilidade_e_injustica_fa <- readRDS(file = "../data/descredibilidade_e_injustica_fa.rds")
constr <- descredibilidade_e_injustica_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>% 
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  mutate(
    MR1 = if_else(MR1 > 0.425, MR1, 0.0),
    MR2 = if_else(MR1 < 0.425, MR2, 0.0),
  ) %>%
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>% 
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width = FALSE, 
    font_size = 12, 
    fixed_thead = TRUE
  ) 
```

```{r descredibilidade_e_injustica_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^descredibilidade_e_injustica")) %>%
  bind_cols(
    predict(
      descredibilidade_e_injustica_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("descredibilidade_e_injustica", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Despreparo da Liderança


```{r despreparo_da_lideranca_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Despreparo da Liderança")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```


```{r despreparo_da_lideranca_b, fig.height=12}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Despreparo da Liderança"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r despreparo_da_lideranca_c}
## polychoric             
# despreparo_da_lideranca_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(despreparo_da_lideranca_pc, file = "../data/despreparo_da_lideranca_pc.rds")
```

```{r despreparo_da_lideranca_g, fig.width=12, fig.height=10}
despreparo_da_lideranca_pc <- readRDS(file = "../data/despreparo_da_lideranca_pc.rds")

library("pheatmap")
pheatmap(
  (despreparo_da_lideranca_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 2, 
  cutree_cols = 2, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r despreparo_da_lideranca_e, include=FALSE}
## factor analysis
despreparo_da_lideranca_fa_par = fa.parallel(despreparo_da_lideranca_pc$correlations, n.obs = nrow(colaboradores))
```

```{r despreparo_da_lideranca_eeee}
plot(despreparo_da_lideranca_fa_par)
```


```{r despreparo_da_lideranca_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in% c("Despreparo da Liderança")
  ) %>%
  pluck("conclusao") %>%
  cat
```


```{r despreparo_da_lideranca_ee, fig.width=8}
despreparo_da_lideranca_fa <- fa(
  despreparo_da_lideranca_pc$correlations, 
  nfactors = 2, # despreparo_da_lideranca_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(despreparo_da_lideranca_fa, file = "../data/despreparo_da_lideranca_fa.rds")
```

```{r despreparo_da_lideranca_f}
despreparo_da_lideranca_fa <- readRDS(file = "../data/despreparo_da_lideranca_fa.rds")
constr <- despreparo_da_lideranca_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>% 
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>% 
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width = FALSE, 
    font_size = 12, 
    fixed_thead = TRUE
  ) 
```


```{r despreparo_da_lideranca_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^despreparo_da_lideranca")) %>%
  bind_cols(
    predict(
      despreparo_da_lideranca_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("despreparo_da_lideranca", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Baixo Preparo da Empresa Para Exercer Função


```{r baixo_preparo_da_empresa_para_exercer_funcao_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Baixo Preparo da Empresa Para Exercer Função")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Baixo Preparo da Empresa Para Exercer Função"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r baixo_preparo_da_empresa_para_exercer_funcao_c}
## polychoric             
# baixo_preparo_da_empresa_para_exercer_funcao_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(baixo_preparo_da_empresa_para_exercer_funcao_pc, file = "../data/baixo_preparo_da_empresa_para_exercer_funcao_pc.rds")
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_g, fig.width=12}
baixo_preparo_da_empresa_para_exercer_funcao_pc <- readRDS(file = "../data/baixo_preparo_da_empresa_para_exercer_funcao_pc.rds")

library("pheatmap")
pheatmap(
  (baixo_preparo_da_empresa_para_exercer_funcao_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 1, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```


```{r baixo_preparo_da_empresa_para_exercer_funcao_ee, include=FALSE}
## factor analysis
baixo_preparo_da_empresa_para_exercer_funcao_fa_par = fa.parallel(baixo_preparo_da_empresa_para_exercer_funcao_pc$correlations, n.obs = nrow(colaboradores))
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_eeee}
plot(baixo_preparo_da_empresa_para_exercer_funcao_fa_par)
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in% c("Baixo Preparo da Empresa Para Exercer Função")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_e, fig.width=8}
baixo_preparo_da_empresa_para_exercer_funcao_fa <- fa(
  baixo_preparo_da_empresa_para_exercer_funcao_pc$correlations, 
  nfactors = 1, #baixo_preparo_da_empresa_para_exercer_funcao_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(baixo_preparo_da_empresa_para_exercer_funcao_fa, file = "../data/baixo_preparo_da_empresa_para_exercer_funcao_fa.rds")
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_f}
baixo_preparo_da_empresa_para_exercer_funcao_fa <- readRDS(file = "../data/baixo_preparo_da_empresa_para_exercer_funcao_fa.rds")
constr <- baixo_preparo_da_empresa_para_exercer_funcao_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%   
  as.data.frame() %>%    
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%  
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%  
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>% 
  kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,   
    font_size = 12,   
    fixed_thead = TRUE
  ) 
```

```{r baixo_preparo_da_empresa_para_exercer_funcao_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^baixo_preparo_da_empresa_para_exercer_funcao")) %>%
  bind_cols(
    predict(
      baixo_preparo_da_empresa_para_exercer_funcao_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("baixo_preparo_da_empresa_para_exercer_funcao", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```





## Planejamento e Método


```{r planejamento_e_metodo_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Planejamento e Método")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r planejamento_e_metodo_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Planejamento e Método"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r planejamento_e_metodo_c}
## polychoric             
# planejamento_e_metodo_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(planejamento_e_metodo_pc, file = "../data/planejamento_e_metodo_pc.rds")
```

```{r planejamento_e_metodo_g, fig.width=12}
planejamento_e_metodo_pc <- readRDS(file = "../data/planejamento_e_metodo_pc.rds")

library("pheatmap")
pheatmap(
  (planejamento_e_metodo_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 2, 
  cutree_cols = 2, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r planejamento_e_metodo_ee, include=FALSE}
## factor analysis
planejamento_e_metodo_fa_par = fa.parallel(planejamento_e_metodo_pc$correlations, n.obs = nrow(colaboradores))
```

```{r planejamento_e_metodo_eeee}
plot(planejamento_e_metodo_fa_par)
```

```{r planejamento_e_metodo_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Planejamento e Método")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r planejamento_e_metodo_e, fig.width=8}
planejamento_e_metodo_fa <- fa(
  planejamento_e_metodo_pc$correlations[-6,-6], 
  nfactors = planejamento_e_metodo_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(planejamento_e_metodo_fa, file = "../data/planejamento_e_metodo_fa.rds")
```

```{r planejamento_e_metodo_f}
planejamento_e_metodo_fa <- readRDS(file = "../data/planejamento_e_metodo_fa.rds")
constr <- planejamento_e_metodo_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%    as.data.frame() %>%   
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%   
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>% 
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%   kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
    full_width = FALSE,    
    font_size = 12,    
    fixed_thead = TRUE 
  ) 
```


```{r planejamento_e_metodo_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^planejamento_e_metodo")) %>%
  bind_cols(
    predict(
      planejamento_e_metodo_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome[-6]) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("planejamento_e_metodo", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Imediatismo


```{r imediatismo_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Imediatismo")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r imediatismo_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Imediatismo"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r imediatismo_c}
## polychoric             
# imediatismo_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(imediatismo_pc, file = "../data/imediatismo_pc.rds")
```

```{r imediatismo_g, fig.width=12}
imediatismo_pc <- readRDS(file = "../data/imediatismo_pc.rds")

library("pheatmap")
pheatmap(
  (imediatismo_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 1, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r imediatismo_ee, include=FALSE}
## factor analysis
imediatismo_fa_par = fa.parallel(imediatismo_pc$correlations, n.obs = nrow(colaboradores))
```

```{r imediatismo_eeee}
par(imediatismo_fa_par)
```

```{r imediatismo_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Imediatismo")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r imediatismo_e, fig.width=8}
imediatismo_fa <- fa(
  imediatismo_pc$correlations, 
  nfactors = 5, #imediatismo_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(imediatismo_fa, file = "../data/imediatismo_fa.rds")
```

```{r imediatismo_f}
imediatismo_fa <- readRDS(file = "../data/imediatismo_fa.rds")
constr <- imediatismo_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%  
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>% 
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%  
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),    
    full_width = FALSE,    
    font_size = 12,   
    fixed_thead = TRUE   
  ) 
```


```{r imediatismo_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^imediatismo")) %>%
  bind_cols(
    predict(
      imediatismo_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("imediatismo", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Ausência de Meritocracia


```{r ausencia_de_meritocracia_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Ausência de Meritocracia")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r ausencia_de_meritocracia_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Ausência de Meritocracia"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r ausencia_de_meritocracia_c}
## polychoric             
# ausencia_de_meritocracia_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(ausencia_de_meritocracia_pc, file = "../data/ausencia_de_meritocracia_pc.rds")
```

```{r ausencia_de_meritocracia_g, fig.width=12}
ausencia_de_meritocracia_pc <- readRDS(file = "../data/ausencia_de_meritocracia_pc.rds")

library("pheatmap")
pheatmap(
  (ausencia_de_meritocracia_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 1, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r ausencia_de_meritocracia_ee, include=FALSE}
## factor analysis
ausencia_de_meritocracia_fa_par = fa.parallel(ausencia_de_meritocracia_pc$correlations, n.obs = nrow(colaboradores))
```

```{r ausencia_de_meritocracia_eeee}
plot(ausencia_de_meritocracia_fa_par)
```

```{r ausencia_de_meritocracia_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Ausência de Meritocracia")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r ausencia_de_meritocracia_e, fig.width=8}
ausencia_de_meritocracia_fa <- fa(
  ausencia_de_meritocracia_pc$correlations, 
  nfactors = 1, #ausencia_de_meritocracia_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(ausencia_de_meritocracia_fa, file = "../data/ausencia_de_meritocracia_fa.rds")
```

```{r ausencia_de_meritocracia_f}
ausencia_de_meritocracia_fa <- readRDS(file = "../data/ausencia_de_meritocracia_fa.rds")
constr <- ausencia_de_meritocracia_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%  
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%   
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>% 
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(    
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),      
    full_width = FALSE,  
    font_size = 12,   
    fixed_thead = TRUE 
  ) 
```


```{r ausencia_de_meritocracia_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^ausencia_de_meritocracia")) %>%
  bind_cols(
    predict(
      ausencia_de_meritocracia_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("ausencia_de_meritocracia", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```






## Proximidade da Liderança


```{r proximidade_da_lideranca_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Proximidade da Liderança")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r proximidade_da_lideranca_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Proximidade da Liderança"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r proximidade_da_lideranca_c}
## polychoric             
# proximidade_da_lideranca_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(proximidade_da_lideranca_pc, file = "../data/proximidade_da_lideranca_pc.rds")
```

```{r proximidade_da_lideranca_g, fig.width=12}
proximidade_da_lideranca_pc <- readRDS(file = "../data/proximidade_da_lideranca_pc.rds")

library("pheatmap")
pheatmap(
  (proximidade_da_lideranca_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 2, 
  cutree_cols = 2, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r proximidade_da_lideranca_ee, include=FALSE}
## factor analysis
proximidade_da_lideranca_fa_par = fa.parallel(proximidade_da_lideranca_pc$correlations, n.obs = nrow(colaboradores))
```

```{r proximidade_da_lideranca_eeee}
plot(proximidade_da_lideranca_fa_par)
```

```{r proximidade_da_lideranca_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Proximidade da Liderança")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r proximidade_da_lideranca_e, fig.width=8}
proximidade_da_lideranca_fa <- fa(
  proximidade_da_lideranca_pc$correlations, 
  nfactors = 2, #proximidade_da_lideranca_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(proximidade_da_lideranca_fa, file = "../data/proximidade_da_lideranca_fa.rds")
```

```{r proximidade_da_lideranca_f}
proximidade_da_lideranca_fa <- readRDS(file = "../data/proximidade_da_lideranca_fa.rds")
constr <- proximidade_da_lideranca_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>% 
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>% 
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(    
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),   
    full_width = FALSE,   
    font_size = 12,     
    fixed_thead = TRUE   
  ) 
```


```{r proximidade_da_lideranca_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^proximidade_da_lideranca")) %>%
  bind_cols(
    predict(
      proximidade_da_lideranca_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("proximidade_da_lideranca", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Visão do Propósito Comum


```{r visao_do_proposito_comum_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Visão do Propósito Comum")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r visao_do_proposito_comum_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Visão do Propósito Comum"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r visao_do_proposito_comum_c}
## polychoric             
# visao_do_proposito_comum_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(visao_do_proposito_comum_pc, file = "../data/visao_do_proposito_comum_pc.rds")
```

```{r visao_do_proposito_comum_g, fig.width=10}
visao_do_proposito_comum_pc <- readRDS(file = "../data/visao_do_proposito_comum_pc.rds")

library("pheatmap")
pheatmap(
  (visao_do_proposito_comum_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 1, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r visao_do_proposito_comum_ee, include=FALSE}
## factor analysis
visao_do_proposito_comum_fa_par = fa.parallel(visao_do_proposito_comum_pc$correlations, n.obs = nrow(colaboradores))
```

```{r visao_do_proposito_comum_eeee}
plot(visao_do_proposito_comum_fa_par)
```

```{r visao_do_proposito_comum_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Visão do Propósito Comum")
  ) %>%
  pluck("conclusao") %>%
  cat
```


```{r visao_do_proposito_comum_e, fig.width=8}
visao_do_proposito_comum_fa <- fa(
  visao_do_proposito_comum_pc$correlations, 
  nfactors = visao_do_proposito_comum_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(visao_do_proposito_comum_fa, file = "../data/visao_do_proposito_comum_fa.rds")
```

```{r visao_do_proposito_comum_f}
visao_do_proposito_comum_fa <- readRDS(file = "../data/visao_do_proposito_comum_fa.rds")
constr <- visao_do_proposito_comum_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%  
  as.data.frame() %>%   
  rownames_to_column("Questão") %>%
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%   
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(    
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),   
    full_width = FALSE,   
    font_size = 12,     
    fixed_thead = TRUE   
  ) 
```


```{r visao_do_proposito_comum_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^visao_do_proposito_comum")) %>%
  bind_cols(
    predict(
      visao_do_proposito_comum_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("visao_do_proposito_comum", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Colaboração


```{r colaboracao_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Colaboração")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r colaboracao_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Colaboração"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r colaboracao_c}
## polychoric             
# colaboracao_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(colaboracao_pc, file = "../data/colaboracao_pc.rds")
```

```{r colaboracao_g, fig.width=12}
colaboracao_pc <- readRDS(file = "../data/colaboracao_pc.rds")

library("pheatmap")
pheatmap(
  (colaboracao_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 2, 
  cutree_cols = 2, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r colaboracao_ee, include=FALSE}
## factor analysis
colaboracao_fa_par = fa.parallel(colaboracao_pc$correlations, n.obs = nrow(colaboradores))
```

```{r colaboracao_eeee}
plot(colaboracao_fa_par)
```

```{r colaboracao_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Colaboração")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r colaboracao_e, fig.width=8}
colaboracao_fa <- fa(
  colaboracao_pc$correlations[-1,-1], 
  nfactors = 1, #colaboracao_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(colaboracao_fa, file = "../data/colaboracao_fa.rds")
```

```{r colaboracao_f}
colaboracao_fa <- readRDS(file = "../data/colaboracao_fa.rds")
constr <- colaboracao_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%  
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>% 
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%    
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>% 
  kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),  
    full_width = FALSE,   
    font_size = 12,   
    fixed_thead = TRUE 
  ) 
```


```{r colaboracao_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^colaboracao")) %>%
  bind_cols(
    predict(
      colaboracao_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome[-1]) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("colaboracao", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```






## Ambiente Leve e Flexibilidade


```{r ambiente_leve_e_flexibilidade_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Ambiente Leve e Flexibilidade")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r ambiente_leve_e_flexibilidade_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Ambiente Leve e Flexibilidade"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r ambiente_leve_e_flexibilidade_c}
## polychoric             
# ambiente_leve_e_flexibilidade_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(ambiente_leve_e_flexibilidade_pc, file = "../data/ambiente_leve_e_flexibilidade_pc.rds")
```

```{r ambiente_leve_e_flexibilidade_g, fig.width=12}
ambiente_leve_e_flexibilidade_pc <- readRDS(file = "../data/ambiente_leve_e_flexibilidade_pc.rds")

library("pheatmap")
pheatmap(clustering_method = "median",
         clustering_distance_cols = "euclidean",
         clustering_distance_rows = "euclidean",
         abs(ambiente_leve_e_flexibilidade_pc$correlations) %>% 
           `colnames<-`(1:nrow(.)) %>%
           `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
         cutree_rows = 2, 
         cutree_cols = 2, 
         # clustering_method = "ward",
         breaks = seq(-1,1,length.out = 20), 
         color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
         display_numbers = TRUE, cex = 1.0
)

```

```{r ambiente_leve_e_flexibilidade_ee, include=FALSE}
## factor analysis
ambiente_leve_e_flexibilidade_fa_par = fa.parallel(ambiente_leve_e_flexibilidade_pc$correlations, n.obs = nrow(colaboradores))
```

```{r ambiente_leve_e_flexibilidade_eeee}
plot(ambiente_leve_e_flexibilidade_fa_par)
```

```{r ambiente_leve_e_flexibilidade_eee, results='asis'}
depara_construtos %>% 
  filter(
    construto_texto %in%  c("Ambiente Leve e Flexibilidade")
  ) %>%
  pluck("conclusao") %>%
  cat
```

```{r ambiente_leve_e_flexibilidade_e, fig.width=8}
ambiente_leve_e_flexibilidade_fa <- fa(
  ambiente_leve_e_flexibilidade_pc$correlations[-1, -1], 
  nfactors = 1,#ambiente_leve_e_flexibilidade_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(ambiente_leve_e_flexibilidade_fa, file = "../data/ambiente_leve_e_flexibilidade_fa.rds")
```

```{r ambiente_leve_e_flexibilidade_f}
ambiente_leve_e_flexibilidade_fa <- readRDS(file = "../data/ambiente_leve_e_flexibilidade_fa.rds")
constr <- ambiente_leve_e_flexibilidade_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%  
  as.data.frame() %>%   
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%  
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%  
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),   
    full_width = FALSE,   
    font_size = 12,     
    fixed_thead = TRUE   
  ) 
```


```{r ambiente_leve_e_flexibilidade_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^ambiente_leve_e_flexibilidade")) %>%
  bind_cols(
    predict(
      ambiente_leve_e_flexibilidade_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome[-1]) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("ambiente_leve_e_flexibilidade", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Liderança Sênior


```{r lideranca_senior_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Liderança Sênior")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r lideranca_senior_b, fig.height=9}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Liderança Sênior"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r lideranca_senior_c}
## polychoric             
# lideranca_senior_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(lideranca_senior_pc, file = "../data/lideranca_senior_pc.rds")
```

```{r lideranca_senior_g, fig.width=12, fig.height=8}
lideranca_senior_pc <- readRDS(file = "../data/lideranca_senior_pc.rds")

library("pheatmap")
pheatmap(
  (lideranca_senior_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 1, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r lideranca_senior_ee, include=FALSE}
## factor analysis
lideranca_senior_fa_par = fa.parallel(lideranca_senior_pc$correlations, n.obs = nrow(colaboradores))
```

```{r lideranca_senior_eeee}
plot(lideranca_senior_fa_par)
```


```{r lideranca_senior_e, fig.width=8}
lideranca_senior_fa <- fa(
  lideranca_senior_pc$correlations, 
  nfactors = lideranca_senior_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(lideranca_senior_fa, file = "../data/lideranca_senior_fa.rds")
```

```{r lideranca_senior_f}
lideranca_senior_fa <- readRDS(file = "../data/lideranca_senior_fa.rds")
constr <- lideranca_senior_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%   
  as.data.frame() %>% 
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>%  
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(   
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),   
    full_width = FALSE,   
    font_size = 12,    
    fixed_thead = TRUE  
  ) 
```



```{r lideranca_senior_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^lideranca_senior")) %>%
  bind_cols(
    predict(
      lideranca_senior_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("lideranca_senior", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```




## Inovação


```{r inovacao_a}
variaveis_selecionadas <- papel_das_variaveis %>% 
  filter(
    construto %in% c("Inovação")
  )
colaboradores_sumario <- colaboradores %>% 
  mutate(geral = "geral") %>%
  sumariza_likert(
    variaveis_selecionadas = variaveis_selecionadas$variavel_nome,
    cortes = c("geral")
  )
```

```{r inovacao_b, fig.height=6}

grafico <- grafico_likert(
  colaboradores_sumario %>% mutate(variavel_texto = str_replace(variavel_texto, "\\[->\\]", "")),
  titulo = 'Questões do construto "Inovação"',
  ordena_por_concordo = TRUE
)

grafico
```


### Análise Fatorial

```{r inovacao_c}
## polychoric             
# inovacao_pc <- colaboradores %>% 
#   select_at(vars(!!variaveis_selecionadas$variavel_nome)) %>%
#   as.data.frame %>%
#   hetcor(ML = TRUE) 
# 
# saveRDS(inovacao_pc, file = "../data/inovacao_pc.rds")
```

```{r inovacao_g, fig.width=12}
inovacao_pc <- readRDS(file = "../data/inovacao_pc.rds")

library("pheatmap")
pheatmap(
  (inovacao_pc$correlations) %>% 
    `colnames<-`(1:nrow(.)) %>%
    `rownames<-`(str_wrap(variaveis_selecionadas$variavel_texto, 50)), 
  cutree_rows = 3, 
  cutree_cols = 3, 
  clustering_method = "ward.D2",
  breaks = seq(-1,1,length.out = 20), 
  color = colorRampPalette(c("firebrick3", "white", "firebrick3"))(20),
  display_numbers = TRUE, cex = 1.0
)

```

```{r inovacao_ee, include=FALSE}
## factor analysis
inovacao_fa_par = fa.parallel(inovacao_pc$correlations, n.obs = nrow(colaboradores))
```

```{r inovacao_eeee}
plot(inovacao_fa_par)
```


```{r inovacao_e, fig.width=8}
inovacao_fa <- fa(
  inovacao_pc$correlations[-2, -2], 
  nfactors = inovacao_fa_par$nfact, 
  n.obs = nrow(colaboradores), 
  rotate="varimax"
)

saveRDS(inovacao_fa, file = "../data/inovacao_fa.rds")
```

```{r inovacao_f}
inovacao_fa <- readRDS(file = "../data/inovacao_fa.rds")
constr <- inovacao_fa$Structure %>% as.matrix()
class(constr) <- "matrix"
constr %>%    
  as.data.frame() %>%   
  rownames_to_column("Questão") %>% 
  gather(fator, peso, starts_with("MR")) %>%
  group_by(`Questão`) %>%
  mutate(peso = if_else(peso == max(peso), peso, 0.0)) %>%
  spread(fator, peso) %>% 
  mutate_if(is.numeric, scales::percent) %>% ungroup() %>% mutate(`Questão` = wrap_palavra_grande2(`Questão`)) %>%
  knitr::kable("latex", booktabs = T) %>% column_spec(1, width = "20em") %>%  
  kable_styling(     
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),  
    full_width = FALSE,    
    font_size = 12,     
    fixed_thead = TRUE   
  ) 
```


```{r inovacao_h}

colaboradores_com_construtos <- readr::read_rds(path = "../data/colaboradores_com_construtos.rds")
colaboradores_com_construtos <- colaboradores_com_construtos %>% 
  dplyr::select(-matches("^inovacao")) %>%
  bind_cols(
    predict(
      inovacao_fa, 
      data = colaboradores_com_construtos %>% 
        select(!!variaveis_selecionadas$variavel_nome[-2]) %>% 
        mutate_all(as.numeric) %>% 
        as.matrix
    ) %>%
      as.data.frame.matrix() %>%
      dplyr::mutate_all(~ (. - min(., na.rm = TRUE))/(max(., na.rm = TRUE) - min(., na.rm = TRUE))) %>%
      set_names(paste0("inovacao", 1:ncol(.)))
  )

readr::write_rds(colaboradores_com_construtos, path = "../data/colaboradores_com_construtos.rds")
```







